use std::{collections::HashSet, ops::RangeInclusive};

use rstest::rstest;

#[derive(Debug, Clone, Copy, PartialEq)]
struct Range(usize, usize);

fn overlaps(a: Range, b: Range) -> bool {
    let (la, ha) = (a.0, a.1);
    let (lb, hb) = (b.0, b.1);

    if la == lb || ha == hb || la == hb || lb == ha {
        return true;
    }

    if la > lb && la < hb {
        return true;
    }

    if lb > la && lb < ha {
        return true;
    }

    if ha > lb && ha < hb {
        return true;
    }

    if hb > la && hb < ha {
        return true;
    }

    false
}

pub fn merge_ranges(a: Range, b: Range) -> Range {
    let (la, ha) = (a.0, a.1);
    let (lb, hb) = (b.0, b.1);

    Range(usize::min(la, lb), usize::max(ha, hb))
}

pub fn process(src: &str) -> usize {
    let mut ranges: Vec<Range> = vec![];

    for line in src.lines() {
        if line.is_empty() {
            break;
        }

        let v = line
            .split("-")
            .map(|n| n.parse::<usize>().unwrap())
            .collect::<Vec<_>>();

        ranges.push(Range(v[0], v[1]));
    }

    loop {
        let mut one_overlap = false;
        let mut cleaned_ranges = vec![];

        cleaned_ranges.push(ranges[0]);

        for range in &ranges[1..] {
            let mut found = false;
            for clean_range in &mut cleaned_ranges {
                if overlaps(*range, *clean_range) {
                    *clean_range = merge_ranges(*clean_range, *range);
                    found = true;
                    one_overlap = true;
                    break;
                }
            }

            if !found {
                cleaned_ranges.push(*range);
            }
        }

        ranges = cleaned_ranges;

        ranges.sort_by(|k1, k2| k1.0.cmp(&k2.0));

        if !one_overlap {
            break;
        }
    }

    ranges.iter().map(|r| r.1 - r.0 + 1).sum::<usize>()
}

#[test]
fn test() {
    let input = r#"3-5
10-14
16-20
12-18

1
5
8
11
17
32"#;

    assert_eq!(process(input), 14);
}

#[rstest]
#[case((Range(16, 20), Range(12, 18)), true)]
#[case((Range(12, 20), Range(13, 18)), true)]
#[case((Range(14, 15), Range(12, 18)), true)]
#[case((Range(1, 2), Range(4, 5)), false)]
#[case((Range(8, 9), Range(2, 4)), false)]
fn test_overlaps(#[case] input: (Range, Range), #[case] expected: bool) {
    assert_eq!(expected, overlaps(input.0, input.1));
}

#[rstest]
#[case((Range(16, 20), Range(12, 18)), Range(12, 20))]
#[case((Range(12, 20), Range(13, 18)), Range(12, 20))]
#[case((Range(14, 15), Range(12, 18)), Range(12, 18))]
fn test_merge(#[case] input: (Range, Range), #[case] expected: Range) {
    assert_eq!(expected, merge_ranges(input.0, input.1));
}

const RANGES: [Range; 109] = [
    Range(2926849656827, 6639293324113),
    Range(10969489721640, 18403764801933),
    Range(20692197063956, 29893795471178),
    Range(32473099854200, 37919611527078),
    Range(41349907562740, 41774522574207),
    Range(42184811751483, 42939927863714),
    Range(43408475984169, 43675077324539),
    Range(43774488718992, 44353049092078),
    Range(44353049092078, 44878901857542),
    Range(45678368924024, 46206678322473),
    Range(47164826750116, 47361024801998),
    Range(47711414732167, 48101459314590),
    Range(48101459314590, 48599748552764),
    Range(48979218601718, 49564147441704),
    Range(50706119275619, 57471846270140),
    Range(63771016673447, 67073553206566),
    Range(73018885785881, 73018885785881),
    Range(73018885785882, 77834026423292),
    Range(83381185442305, 89649554304739),
    Range(92322809915656, 96500992032241),
    Range(96500992032243, 99132130072424),
    Range(103413617754955, 106761159794206),
    Range(106761159794207, 109797286672589),
    Range(111393026131754, 116938935377521),
    Range(123060670164629, 128981806607990),
    Range(128981806607991, 128981806607991),
    Range(131956244068873, 140451557409157),
    Range(144972871770017, 146438622404687),
    Range(155241990375049, 158753341898209),
    Range(161136839625356, 170517892204396),
    Range(173766890438257, 175957758472865),
    Range(175957758472866, 180125042122148),
    Range(182040467171807, 188667090942650),
    Range(193243486057894, 199348484912080),
    Range(199348484912081, 199348484912081),
    Range(203262950779385, 210427885914978),
    Range(211893144138358, 211893144138358),
    Range(211893144138359, 220416214547869),
    Range(225088098372733, 228903696285896),
    Range(231837945632642, 238563024987961),
    Range(243032338439851, 248434525048913),
    Range(252347920603579, 253136032139253),
    Range(253136032139253, 253606844838174),
    Range(253909423627332, 255198701548672),
    Range(255810052866577, 256636628520694),
    Range(256636628520694, 257565932343078),
    Range(257950740608376, 258422000237680),
    Range(258927042113314, 259389584228189),
    Range(260262011998310, 261010376339511),
    Range(264187939062085, 266337614971861),
    Range(266337614971863, 269075739287179),
    Range(271796885540557, 281138057310686),
    Range(282968252939607, 285767263902241),
    Range(285767263902242, 290808407176951),
    Range(293208116268102, 299836122735369),
    Range(303126505727739, 310298147703265),
    Range(310298147703266, 310298147703266),
    Range(313598152797785, 313598152797785),
    Range(313598152797786, 320447294233974),
    Range(323511129733906, 330998081341259),
    Range(332319403698102, 333279017622435),
    Range(334299926097448, 335143065701699),
    Range(335143065701699, 335803852255792),
    Range(335803852255792, 336387086275389),
    Range(336585523222916, 337297442663494),
    Range(337671295783509, 339218340247309),
    Range(339558788109240, 340423346550934),
    Range(340608453651022, 340947657402530),
    Range(340947657402530, 341399417684031),
    Range(344557419547678, 349558579467732),
    Range(354090997627981, 360400073357417),
    Range(364781170615862, 370593133584923),
    Range(373228386404357, 377950047962450),
    Range(382102874239472, 391759866838103),
    Range(392760691823518, 400527303704705),
    Range(403689979353004, 407187118727523),
    Range(407187118727525, 409439422719588),
    Range(414963061556680, 417705391099450),
    Range(424773421487922, 427909317529086),
    Range(427909317529088, 430361397578492),
    Range(433693270104647, 441649413313212),
    Range(443650041368133, 449711789570714),
    Range(453019836282384, 461450574663037),
    Range(463955630048892, 468633815583198),
    Range(472794482814995, 482278771585482),
    Range(485306754309739, 489648627846884),
    Range(494606678393202, 497337647859079),
    Range(497337647859080, 501303458833742),
    Range(504829478003777, 511098353423119),
    Range(513425155207406, 519242373171613),
    Range(519242373171614, 519242373171614),
    Range(527069855755228, 527069855755228),
    Range(527069855755229, 528592316960898),
    Range(533506887654215, 534147464247588),
    Range(534147464247588, 534621793593873),
    Range(534621793593873, 535529424319425),
    Range(536154434489667, 536776174176003),
    Range(536935676896000, 537505737647812),
    Range(537765521372718, 538026764120355),
    Range(538124733727473, 538460631796040),
    Range(538460631796040, 538678601952706),
    Range(538678601952706, 539508731838689),
    Range(539508731838689, 540454167785597),
    Range(540454167785597, 540711647857062),
    Range(540711647857062, 541968326469388),
    Range(541968326469388, 542149392091081),
    Range(542149392091081, 542533569726705),
    Range(547113177391816, 550487902990229),
    Range(554887650114065, 560713227264706),
];
